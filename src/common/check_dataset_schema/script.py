
import anndata as ad
import yaml


## VIASH START
# The following code has been auto-generated by Viash.
par = {
  'input': 'resources_test/common/pancreas/dataset.h5ad',
  'schema': 'src/denoising/api/anndata_dataset.yaml',
  'stop_on_error': 'false',
  'copy_output': 'false',
  # 'json': '/path/to/file',
  # 'output': '/path/to/file'
}
meta = {
  'functionality_name': 'foo',

}

## VIASH END

def check_structure (slot_info, adata_slot):
  missing=[]
  for obj in slot_info:
      if obj['name'] not in adata_slot:
         missing.append(obj['name'])

  return missing


print('Load data', flush=True)
adata = ad.read_h5ad(par['dataset'])

with open(par['structure'], 'r') as f:
  data_struct = yaml.safe_load(f)


def_slots = data_struct['info']['slots']

out={
  'exit_code' : 0,
  'error': {}
}

for slot in def_slots:
  if slot not in out['error']:
    out['error'][slot]
  check = check_structure(def_slots[slot], getattr(adata, slot))
  if check is not None:
    out['exit_code'] = 1
    out['error'][slot] = check


exit(out['exit_code'])

